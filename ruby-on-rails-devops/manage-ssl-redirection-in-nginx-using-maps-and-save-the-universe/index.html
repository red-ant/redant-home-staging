<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="google-site-verification" content="uky3VJEeD3NAFHIK0V4KLdxlYF7fGGXJYyyt96LLe78" />
  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Manage SSL redirection in Nginx using maps, and save the universe | Red Ant</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Manage SSL redirection in Nginx using maps, and save the universe" />
<meta name="author" content="Sam Bauers" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A simple tutorial showing how to manage a large list of rewrite rules to enforce SSL/HTTPS or PLAIN/HTTP in Nginx." />
<meta property="og:description" content="A simple tutorial showing how to manage a large list of rewrite rules to enforce SSL/HTTPS or PLAIN/HTTP in Nginx." />
<link rel="canonical" href="https://redant.com.au/ruby-on-rails-devops/manage-ssl-redirection-in-nginx-using-maps-and-save-the-universe/" />
<meta property="og:url" content="https://redant.com.au/ruby-on-rails-devops/manage-ssl-redirection-in-nginx-using-maps-and-save-the-universe/" />
<meta property="og:site_name" content="Red Ant" />
<meta property="og:image" content="https://redant.com.au/assets/uploads/2012/milo-on-floor.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2012-03-28T00:00:00+00:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://redant.com.au/assets/uploads/2012/milo-on-floor.jpg" />
<meta property="twitter:title" content="Manage SSL redirection in Nginx using maps, and save the universe" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Sam Bauers"},"dateModified":"2012-03-28T00:00:00+00:00","datePublished":"2012-03-28T00:00:00+00:00","description":"A simple tutorial showing how to manage a large list of rewrite rules to enforce SSL/HTTPS or PLAIN/HTTP in Nginx.","headline":"Manage SSL redirection in Nginx using maps, and save the universe","image":"https://redant.com.au/assets/uploads/2012/milo-on-floor.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://redant.com.au/ruby-on-rails-devops/manage-ssl-redirection-in-nginx-using-maps-and-save-the-universe/"},"url":"https://redant.com.au/ruby-on-rails-devops/manage-ssl-redirection-in-nginx-using-maps-and-save-the-universe/"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="icon" href="/assets/images/favicon.ico" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" />
  <link rel="stylesheet" href="/assets/bundle/application.css" />
  <script src="/assets/bundle/application.js"></script>
  <script src="https://kit.fontawesome.com/c0cec62a8d.js" crossorigin="anonymous"></script>
  <script>
    if (!(window.fetch && window.Promise && [].includes && Object.assign && window.Map)) {
      document.write('<script src="https://cdn.polyfill.io/v3/polyfill.min.js?features=default,fetch"></scr'+'ipt>')
    }
  </script>
  
    <style>.async-hide { opacity: 0 !important} </style>

<script>
  var gtmId = window.location.host.includes("redant.com.au")
    ? "GTM-P7QNBDH"
    : "GTM-N3CM249";

  // Google Optimize page hiding snippet
  (function(a,s,y,n,c,h,i,d,e){s.className+=' '+y;
  h.end=i=function(){s.className=s.className.replace(RegExp(' ?'+y),'')};
  (a[n]=a[n]||[]).hide=h;setTimeout(function(){i();h.end=null},c);
  })(window,document.documentElement,'async-hide','dataLayer',500,{[gtmId]:true});

  // Google Tag Manager
  (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
  new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
  })(window,document,'script','dataLayer',gtmId);
</script>

  
</head>

  <body class="">
    <div class="main-layout">
      <div
  data-controller="nav reveal normalise-height"
  data-reveal-hidden-class="open"
  data-action="normalise:height->nav#setHeight">
  <div class="nav-container" data-normalise-height-target="item">
    
      <div class="bg-dark text-white text-center p-2">
        <strong>A new way of working with us!</strong>
        Low monthly fixed cost. Access our team on demand to help you scale.
        <a href="/on-demand/" class="fw-bold ms-2">More info</a>
      </div>
    
    
    <nav class="navbar nav-overlay" data-reveal-target="item">
    
      <div class="container">
        <div class="d-flex flex-column">
          <div class="d-flex justify-content-between">
            <a href="/" class="navbar-brand">
              <img
                class="logo"
                src="/assets/images/logo.svg"
                alt="Red Ant logo"
              />
            </a>
            <div class="d-flex justify-content-end align-items-center w-100">
              <div class="d-none d-lg-block">
                <ul class="nav justify-content-end">
                  <li class="nav-item">
                    <a href="/get-started/" data-nav-target="item" class="nav-link">
                      Get started
                    </a>
                  </li>
                  
                  <li class="nav-item">
                    <a href="/on-demand/" data-nav-target="item" class="nav-link">
                      On Demand
                    </a>
                  </li>
                  
                  <li class="nav-item">
                    <a href="/about/" data-nav-target="item" class="nav-link">
                      About us
                    </a>
                  </li>
                  <li class="nav-item">
                    <a href="/portfolio/" data-nav-target="item" class="nav-link">
                      Portfolio
                    </a>
                  </li>
                  <li class="nav-item">
                    <a href="/technology/" data-nav-target="item" class="nav-link">
                      Technology
                    </a>
                  </li>
                  <li class="nav-item">
                    <a href="/blog/" data-nav-target="item" class="nav-link">Blog</a>
                  </li>
                  <li class="nav-item">
                    <a href="/contact-us/" data-nav-target="item" class="nav-link">
                      Contact
                    </a>
                  </li>
                </ul>
              </div>
              <button
                type="button"
                class="btn btn-link d-block d-lg-none nav-toggle-icon"
                data-action="click->reveal#toggle">
                <span></span>
                <span></span>
                <span></span>
                <span></span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="container nav-links mx-4 mx-md-auto">
        <ul class="links">
          <li>
            <a href="/" data-nav-target="item">Home</a>
          </li>
          <li>
            <a href="/get-started/" data-nav-target="item">Get started</a>
          </li>
          
          <li>
            <a href="/on-demand/" data-nav-target="item">On Demand</a>
          </li>
          
          <li>
            <a href="/about/" data-nav-target="item">About us</a>
          </li>
          <li>
            <a href="/portfolio/" data-nav-target="item">Portfolio</a>
          </li>
          <li>
            <a href="/technology/" data-nav-target="item">Technology</a>
          </li>
          <li>
            <a href="/blog/" data-nav-target="item">Blog</a>
          </li>
          <li>
            <a href="/contact-us/" data-nav-target="item">Contact</a>
          </li>
        </ul>
      </div>
    </nav>
  </div>
</div>

      <section class="post-content pt-3 pb-5 text-md">
        <div class="container">
          <div class="row mb-sm-4">
            <div class="col-12">
              <div class="mb-3 pb-sm-5"><div id="breadcrumbs" class="text-capitalize mt-sm-5">
  
  <a href="/">Home</a>
    /
  <a
    href="/ruby-on-rails-devops/"
    >Ruby on rails devops</a
  >
     / Manage ssl redirection in nginx using maps and save the universe  
</div>
</div>
              <h1 class="pb-2">Manage SSL redirection in Nginx using maps, and save the universe</h1>
              <hr class="dash" />
            </div>
          </div>
          <div class="row">
            <div class="col-md-8 order-2 order-sm-1">
              <img
                class="img-fluid mb-4"
                src="/assets/uploads/2012/milo-on-floor.jpg"
                alt="Manage SSL redirection in Nginx using maps, and save the universe"
              />
              <h2 id="the-problem">The problem</h2>

<p>We need to be able to enforce SSL connections (HTTPS) on some URLs. We also need to be able to enforce PLAIN connections (HTTP) on others. Further, there are some URLs which we want to just stay with whatever protocol they were requested on so they won’t redirect at all.</p>

<p>One approach is to use a great big series of rewrite rules, but that would be pretty unwieldy, would involve a bunch of regular expression variable capturing, and likely also mean using more than a couple of if blocks (which I have been told are <a href="http://wiki.nginx.org/IfIsEvil">evil (Nginx wiki - if is evil)</a> and slow, even if few people have the sort of traffic where that really matters). We also may have to maintain them across two virtual hosts, making it hard to check for conflicts between the two lists. In cases where the virtual host pulls double duty serving HTTP on port 80 and HTTPS on port 443 simultaneously, we would have to check the protocol first as well, further confusing the config. There has to be a better way.</p>

<p>We already use <a href="http://wiki.nginx.org/HttpMapModule">Nginx maps (Nginx HttpMapModule)</a> to create standard redirect lists on some sites, but mostly these are static lists which are used to redirect old URLs to new ones. We do this so that when we rebuild sites using Ruby on Rails they don’t loose the Google juice that is already attached to all those horrible, horrible <code class="language-plaintext highlighter-rouge">default.aspx?foo=bar&amp;578432754230</code> URLs…</p>

<p>Yes, I’m looking at <strong>you</strong> .NET developers.</p>

<img src="/assets/uploads/2012/milo-on-floor.jpg" alt="Red Ant office doggo" width="610" height="457" />
<p>The wiki page on <a href="http://wiki.nginx.org/HttpMapModule">Nginx maps (Nginx HttpMapModule)</a> gives a basic example of using a map to redirect request URLs to new locations. But that is no good for us, because we explicitly want to redirect only if the protocol is not our preferred one. We also only want to redirect to the same URL, albeit over a different protocol. A basic map like that will send our client into a redirect loop. We would need two separate maps and that kind of takes us back to square one. There is also potentially a problem with making matches too broad in separate maps and causing redirect loops again, whereas a single map will match only one value. Using one map we can also take advantage of the map default. It’s complicated, so just trust me <strong>separate maps = do not want!</strong></p>

<h2 id="the-solution">The solution</h2>

<p>Rather than build a map of request URIs to redirect locations, we are instead going to build a map of request URIs and their preferred protocols http, https, or none.</p>

<p>Here’s what a really simple example of that might look like:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>map $uri $example_org_preferred_proto {
default "http";
~^/(images|css|javascript)/ "none";
~^/sign-up/ "https";
~^/account/ "https";
}
</code></pre></div></div>

<p>The first line defines the <code class="language-plaintext highlighter-rouge">map</code> block. The first variable <code class="language-plaintext highlighter-rouge">$uri</code> is what we are checking against in our case the incoming request URL without the protocol, host name or query string. The second variable <code class="language-plaintext highlighter-rouge">$example_org_preferred_proto</code> is what we will map the result of the match to.</p>

<p>The second line is a special default case inside the map. Most of our URLs should always be HTTP, so if none of the patterns in the block match the requested URL, then the result will default to this value of http. You may want to default to one of the other values depending on which will save you more rules and give you the shortest list.</p>

<p>The third line is matching our static assets directories which we need to be available over both HTTP and HTTPS. So we assign them a value of none. Since Nginx 0.9.6 you can use regular expressions inside maps. The tilde character <code class="language-plaintext highlighter-rouge">~</code> at the start of this line indicates that this is a regular expression. These work like other regular expressions in Nginx which I <strong>wont</strong> explain here.</p>

<p>The fourth and fifth lines make sure that our sign ups and account management pages are always HTTPS. This could have been done in one line like the previous one, but part of the point of doing this is to create logical and readable groupings of URLs to ease ongoing maintenance. In a much longer list, this will matter more.</p>

<p>Inside our virtual host configuration we can apply the map like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>map $uri $example_org_preferred_proto {
  default "http";
  ~^/(images|css|javascript)/ "none";
  ~^/sign-up/ "https";
  ~^/account/ "https";
}
server {
  listen 80;
  server_name example.org;
  root /var/www/example.org/htdocs;
  if ($example_org_preferred_proto = "https") {
    return 301 https://example.org$request_uri;
  }
}
server {
  listen 443 ssl;
  server_name example.org;
  ssl_certificate /var/ssl/example.org.crt;
  ssl_certificate_key /var/ssl/example.org.key;
  root /var/www/example.org/htdocs;
  if ($example_org_preferred_proto = "http") {
    return 301 http://example.org$request_uri;
  }
}
</code></pre></div></div>

<p>Note that the map is defined outside of the <code class="language-plaintext highlighter-rouge">server</code> blocks. That’s one of the advantages of this method over a series of rewrites the map is setup when Nginx starts and is available globally throughout the configuration. This is supposed to improve performance but I don’t know why exactly as the mapping itself occurs on demand. I’m happy to remain ignorant of the specifics here. It also is a bit easier on the readability of your logs if you are debugging your Nginx configuration as it outputs less debug lines.</p>

<p>The real payoff is in those <code class="language-plaintext highlighter-rouge">if</code> blocks, we simply query the preferred scheme for this request and if it doesn’t match, then we redirect to it. Here Ive used permanent redirects by indicating 301, but during testing it is wise to use temporary redirects by indicating 302 instead.</p>

<h2 id="but-im-behind-a-load-balancer-which-handles-the-ssl-so-this-wont-work-for-me">But I’m behind a load balancer which handles the SSL, so this won’t work for me!</h2>

<p>True, very true. Some people are behind load balancers which do SSL termination for the incoming requests. This means that they are usually utilising a single <code class="language-plaintext highlighter-rouge">server</code> block for their virtual host configuration and that virtual host is set to only listen on port 80, because everything being passed to it is in PLAIN/HTTP.</p>

<p>For these cases we need to make a couple of adjustments to use the X-Forwarded-Proto header that is usually sent by the load balancer. By doing so we can detect the incoming request’s original protocol, a task which was done automatically in the previous example due to the separate server blocks listening on different ports.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>map $uri $example_org_preferred_proto {
  default "http";
  ~^/(images|css|javascript)/ "none";
  ~^/sign-up/ "https";
  ~^/account/ "https";
}
server {
  listen 80;
  server_name example.org;
  root /var/www/example.org/htdocs;
  # If there is no preferred protocol, then prefer the current protocol
  if ($example_org_preferred_proto = "none") {
    set $example_org_preferred_proto $http_x_forwarded_proto;
  }
  # Redirect if the forwarded protocol doesn't match the preferred scheme
  if ($example_org_preferred_proto != $http_x_forwarded_proto) {
    return 301 $example_org_preferred_proto://example.org$request_uri;
  }
}
</code></pre></div></div>

<p>We have to add an additional <code class="language-plaintext highlighter-rouge">if</code> block here so that our URLs that prefer none don’t go into redirect loops. It simply re-maps the URLs preferred protocol to whatever the forwarded protocol was. For those URLs, the next <code class="language-plaintext highlighter-rouge">if</code> block will never be true, so no redirect occurs for none. Great!</p>

<p>It might be possible to map the none URLs directly to <code class="language-plaintext highlighter-rouge">$http_x_forwarded_proto</code> in the map itself, but my guess is that doing so would be slower for large lists due to the variable requiring expansion several times.</p>

<p>In the second <code class="language-plaintext highlighter-rouge">if</code> block we simply redirect to the preferred protocol if it doesn’t match the forwarded protocol from the load balancer. That covers both the remaining http and https cases.</p>

<p>If you aren’t behind a load balancer, but use a single server block listening on port 80 and 443 for HTTP and HTTPS traffic, you can probably use a similar method, substituting <code class="language-plaintext highlighter-rouge">$http_x_forwarded_proto</code> with <code class="language-plaintext highlighter-rouge">$scheme</code>.</p>

<p>If you have a big map, then you may hit Nginx’s memory limit for map hashes. This can be increased using the directives <a href="http://wiki.nginx.org/HttpMapModule#map_hash_max_size">map_hash_max_size (Nginx HttpMapModule map_hash_max_size)</a> and <a href="http://wiki.nginx.org/HttpMapModule#map_hash_bucket_size">map_hash_bucket_size (Nginx HttpMapModule map_hash_bucket_size)</a>. In any case, Nginx will tell you what’s up when you try to restart it.</p>

<p>If you have any questions specific to your setup, or any suggestions for improving these methods then drop a comment here.</p>

            </div>
            <div class="col-md-4 order-1 order-sm-2">
              
              <div class="post-detail-container section-border">
                <p>A simple tutorial showing how to manage a large list of rewrite rules to enforce SSL/HTTPS or PLAIN/HTTP in Nginx.</p>
              </div>
              
              
<div data-controller="modal-carousel">
  

  <div
    id="gallery-modal"
    class="modal fade"
    role="dialog"
    tabindex="-1"
    aria-labelledby="gallery-modal"
    aria-hidden="true"
    data-modal-carousel-target="modal">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-header">
        <button
          type="button"
          class="btn-close btn-close-white text-lg pe-auto"
          data-bs-dismiss="modal"
          aria-label="Close">
        </button>
      </div>
      <div class="modal-content">
        <div
          id="gallery-carousel"
          class="carousel slide"
          data-bs-ride="carousel"
          data-modal-carousel-target="carousel">
          <div class="carousel-inner">
            
          </div>
          <button
            type="button"
            class="carousel-control-prev"
            data-bs-target="#gallery-carousel"
            data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>
          <button
            type="button"
            class="carousel-control-next"
            data-bs-target="#gallery-carousel"
            data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

            </div>
          </div>
        </div>
      </section>
      <section class="pb-5 d-none d-sm-block">
        <div class="container" data-controller="fake-news"></div>
      </section>
      <footer class="footer py-5">
  <div class="container">
    <div class="row mb-4">
      <div class="col-6 col-lg-4 order-1">
        <p>
          <a href="mailto:info@redant.com.au">info@redant.com.au</a>
          <br>
          <a href="tel:+61292678300">+61 2 9267 8300</a>
          <br>
          <a href="/privacy-policy">Red Ant Privacy Policy</a>
        </p>
      </div>

      <div class="col-8 offset-2 col-md-12 offset-md-0 col-lg-4 order-3 order-lg-2">
        <p>
          <i class="fa fa-twitter"></i>
          <a href="https://twitter.com/r_e_d_a_n_t" target="_blank" class="ms-2">
            The most mundane Twitter, ever
          </a>
          <br>
          <i class="fa fa-linkedin-square"></i>
          <a href="https://www.linkedin.com/company/76862" target="_blank" class="ms-2">
            Stalk us on Linkedin
          </a>
        </p>
      </div>

      <div class="col-6 col-lg-4 order-2 order-lg-3">
        <p>
          PO Box 250, Vaucluse Sydney NSW 2030 Australia
          <br>
          ABN 87 081 223 252
        </p>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col px-lg-5 text-center link-list">
        <a href="/jobs/" class="pri me-2">Careers</a>
        <span> | </span>
        <a href="/blog/" class="mx-2">Blog</a>
        <span> | </span>
        <a href="/automated-testing/" class="mx-2">Automated Testing</a>
        <span> | </span>
        <a href="/mobile/" class="mx-2">Mobile</a>
        <span> | </span>
        <a href="/software-development/" class="mx-2">Ruby Development</a>
        <span> | </span>
        <a href="/our-work/" class="mx-2">Our Work</a>
        <span> | </span>
        <a href="/red-ant-stuff/" class="mx-2">Red Ant</a>
        <span> | </span>
        <a href="/ruby-on-rails-devops/" class="mx-2">Devops</a>
        <span> | </span>
        <a href="/ruby-on-rails/" class="mx-2">Ruby on Rails developer</a>
        <span> | </span>
        <a href="/strategy/" class="mx-2">Strategy</a>
        <span> | </span>
        <a href="/our-work/" class="mx-2">Work updates</a>
        <span> | </span>
        <a href="/tool-reviews/" class="mx-2">Tool Reviews</a>
        <span> | </span>
        <a href="/portfolio/" class="mx-2">Our Portfolio</a>
        <span> | </span>
        <a href="/about/" class="mx-2">About Red Ant</a>
      </div>
    </div>

    <div class="row">
      <div class="col text-center">
        &copy; Red Ant 2022
      </div>
    </div>
  </div>
</footer>

<script>
  window.intercomSettings = {
    api_base: "https://api-iam.intercom.io",
    app_id: "fd4z6tu3",
    custom_launcher_selector:'.intercom-launcher'
  };
</script>

<script>
  // We pre-filled your app ID in the widget URL: 'https://widget.intercom.io/widget/fd4z6tu3'
  (function () {
    var w = window;
    var ic = w.Intercom;
    if (typeof ic === "function") {
      ic("reattach_activator");
      ic("update", w.intercomSettings);
    } else {
      var d = document;
      var i = function () {
        i.c(arguments);
      };
      i.q = [];
      i.c = function (args) {
        i.q.push(args);
      };
      w.Intercom = i;
      var l = function () {
        var s = d.createElement("script");
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://widget.intercom.io/widget/fd4z6tu3";
        var x = d.getElementsByTagName("script")[0];
        x.parentNode.insertBefore(s, x);
      };
      if (document.readyState === "complete") {
        l();
      } else if (w.attachEvent) {
        w.attachEvent("onload", l);
      } else {
        w.addEventListener("load", l, false);
      }
    }
  })();
</script>

    </div>
  </body>
</html>
